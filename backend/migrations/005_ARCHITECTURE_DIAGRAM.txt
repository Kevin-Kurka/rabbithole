================================================================================
EVIDENCE MANAGEMENT SYSTEM - COMPLETE ARCHITECTURE
================================================================================
Version: 1.0.0
Date: 2025-10-09
================================================================================

┌─────────────────────────────────────────────────────────────────────────────┐
│                            CLIENT LAYER                                      │
└─────────────────────────────────────────────────────────────────────────────┘

    ┌─────────────┐      ┌─────────────┐      ┌─────────────┐
    │   Browser   │      │   Mobile    │      │   Desktop   │
    │     App     │      │     App     │      │     App     │
    └──────┬──────┘      └──────┬──────┘      └──────┬──────┘
           │                    │                    │
           └────────────────────┼────────────────────┘
                                │
                         HTTPS / GraphQL
                                │
┌─────────────────────────────────────────────────────────────────────────────┐
│                              API LAYER                                       │
└─────────────────────────────────────────────────────────────────────────────┘

                         ┌──────────────┐
                         │Load Balancer │
                         └──────┬───────┘
                                │
               ┌────────────────┼────────────────┐
               │                │                │
        ┌──────▼──────┐  ┌──────▼──────┐  ┌──────▼──────┐
        │ GraphQL API │  │ GraphQL API │  │ GraphQL API │
        │  Server 1   │  │  Server 2   │  │  Server 3   │
        └──────┬──────┘  └──────┬──────┘  └──────┬──────┘
               │                │                │
               └────────────────┼────────────────┘
                                │
┌─────────────────────────────────────────────────────────────────────────────┐
│                           SERVICE LAYER                                      │
└─────────────────────────────────────────────────────────────────────────────┘

    ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
    │ Evidence Service│    │ Storage Service │    │ Search Service  │
    │                 │    │                 │    │                 │
    │ - Upload Files  │───▶│ - S3 Provider   │    │ - Full-Text     │
    │ - Attachments   │    │ - Local Provider│    │ - Faceted       │
    │ - Metadata      │    │ - CDN URLs      │    │ - Ranking       │
    │ - Reviews       │    │ - Signed URLs   │    │ - Suggestions   │
    └────────┬────────┘    └────────┬────────┘    └────────┬────────┘
             │                      │                      │
             │                      │                      │
    ┌────────▼────────┐    ┌────────▼────────┐    ┌────────▼────────┐
    │  Security Svc   │    │  Queue Service  │    │  Analytics Svc  │
    │                 │    │                 │    │                 │
    │ - Virus Scan    │    │ - Async Jobs    │    │ - Metrics       │
    │ - Validation    │    │ - Thumbnails    │    │ - Reporting     │
    │ - Auth Check    │    │ - Search Index  │    │ - Aggregations  │
    └─────────────────┘    └─────────────────┘    └─────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                         STORAGE LAYER                                        │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                      FILE STORAGE (Multi-Provider)                           │
└─────────────────────────────────────────────────────────────────────────────┘

    Production:                    Development:               Archive:

    ┌─────────────┐               ┌─────────────┐           ┌─────────────┐
    │   AWS S3    │               │    Local    │           │   Glacier   │
    │             │               │  FileSystem │           │  Deep Archive│
    │ - Standard  │               │             │           │             │
    │ - IA Tier   │               │ /var/files  │           │ Cold Storage│
    │ - Glacier   │               └─────────────┘           └─────────────┘
    └──────┬──────┘
           │
    ┌──────▼──────┐
    │ CloudFront  │
    │     CDN     │
    │             │
    │ - Caching   │
    │ - SSL/TLS   │
    │ - Global    │
    └─────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                       DATABASE LAYER (PostgreSQL)                            │
└─────────────────────────────────────────────────────────────────────────────┘

    Primary Database                      Read Replicas

    ┌──────────────────┐                 ┌──────────────────┐
    │  PostgreSQL 14+  │────Replication─▶│   Read Replica   │
    │                  │                 │                  │
    │ - Read/Write     │                 │ - Read Only      │
    │ - ACID           │                 │ - Analytics      │
    │ - Partitioned    │                 │ - Search Queries │
    └────────┬─────────┘                 └──────────────────┘
             │
             │
    ┌────────▼─────────────────────────────────────────────────────┐
    │                    EVIDENCE SCHEMA                            │
    └───────────────────────────────────────────────────────────────┘

    Core Tables:                Metadata Tables:

    ┌──────────────┐           ┌──────────────────┐
    │   Evidence   │◄──────────┤EvidenceMetadata  │
    │  (from 003)  │           │                  │
    │              │           │ - authors        │
    │ - id         │           │ - publication    │
    │ - source_id  │           │ - doi/isbn       │
    │ - content    │           │ - keywords       │
    │ - weight     │           │ - geolocation    │
    └──────┬───────┘           │ - sample_size    │
           │                   └──────────────────┘
           │
    ┌──────▼───────┐           ┌──────────────────┐
    │EvidenceFiles │           │EvidenceAttachments│
    │              │           │                  │
    │ - file_type  │           │ - evidence_id    │
    │ - storage    │           │ - target_node    │
    │ - file_hash  │           │ - target_edge    │
    │ - file_size  │           │ - relevance      │
    │ - cdn_url    │           └──────────────────┘
    └──────┬───────┘
           │
    ┌──────▼───────┐           ┌──────────────────┐
    │EvidenceReviews│          │EvidenceAuditLog  │
    │              │           │                  │
    │ - quality    │           │ - action         │
    │ - credibility│           │ - actor          │
    │ - rating     │           │ - changes        │
    │ - review_text│           │ - ip_address     │
    └──────────────┘           └──────────────────┘

    Search & Analytics:

    ┌─────────────────────┐    ┌──────────────────┐
    │EvidenceSearchIndex  │    │EvidenceDuplicates│
    │                     │    │                  │
    │ - search_vector     │    │ - evidence_id_1  │
    │ - file_types        │    │ - evidence_id_2  │
    │ - authors           │    │ - file_hash_match│
    │ - keywords          │    │ - similarity     │
    │ - avg_quality       │    │ - status         │
    └─────────────────────┘    └──────────────────┘

    Views:

    ┌────────────────────┐     ┌──────────────────┐
    │EvidenceFullDetails │     │EvidenceQualityRpt│
    │  (Comprehensive)   │     │  (Aggregated)    │
    └────────────────────┘     └──────────────────┘

================================================================================
DATA FLOW DIAGRAMS
================================================================================

┌─────────────────────────────────────────────────────────────────────────────┐
│                         FILE UPLOAD FLOW                                     │
└─────────────────────────────────────────────────────────────────────────────┘

    User                API              Security           Storage          Database
     │                  │                   │                 │                │
     │ Upload File      │                   │                 │                │
     ├─────────────────▶│                   │                 │                │
     │                  │ Validate          │                 │                │
     │                  ├──────────┐        │                 │                │
     │                  │          │        │                 │                │
     │                  │◄─────────┘        │                 │                │
     │                  │                   │                 │                │
     │                  │ Virus Scan        │                 │                │
     │                  ├──────────────────▶│                 │                │
     │                  │          Clean    │                 │                │
     │                  │◄──────────────────┤                 │                │
     │                  │                   │                 │                │
     │                  │ Upload File       │                 │                │
     │                  ├────────────────────────────────────▶│                │
     │                  │          Storage Key + Hash         │                │
     │                  │◄────────────────────────────────────┤                │
     │                  │                   │                 │                │
     │                  │ Save Metadata     │                 │                │
     │                  ├────────────────────────────────────────────────────▶│
     │                  │                   │                 │   Check Dups  │
     │                  │                   │                 │   Update Index│
     │                  │                   │                 │   Log Audit   │
     │                  │          Success  │                 │                │
     │ File URL         │◄────────────────────────────────────────────────────┤
     │◄─────────────────┤                   │                 │                │
     │                  │                   │                 │                │

┌─────────────────────────────────────────────────────────────────────────────┐
│                       SEARCH QUERY FLOW                                      │
└─────────────────────────────────────────────────────────────────────────────┘

    User                API              Cache             Database          Storage
     │                  │                  │                  │                │
     │ Search Query     │                  │                  │                │
     ├─────────────────▶│                  │                  │                │
     │                  │ Check Cache      │                  │                │
     │                  ├─────────────────▶│                  │                │
     │                  │       Miss       │                  │                │
     │                  │◄─────────────────┤                  │                │
     │                  │                  │                  │                │
     │                  │ Full-Text Search │                  │                │
     │                  ├────────────────────────────────────▶│                │
     │                  │          Results (ranked)           │                │
     │                  │◄────────────────────────────────────┤                │
     │                  │                  │                  │                │
     │                  │ Get File URLs    │                  │                │
     │                  ├───────────────────────────────────────────────────▶ │
     │                  │          Signed URLs                │                │
     │                  │◄───────────────────────────────────────────────────┤
     │                  │                  │                  │                │
     │                  │ Cache Results    │                  │                │
     │                  ├─────────────────▶│                  │                │
     │                  │                  │                  │                │
     │ Search Results   │                  │                  │                │
     │◄─────────────────┤                  │                  │                │
     │                  │                  │                  │                │

┌─────────────────────────────────────────────────────────────────────────────┐
│                     REVIEW SUBMISSION FLOW                                   │
└─────────────────────────────────────────────────────────────────────────────┘

    Reviewer           API              Database           Notification      Evidence
     │                  │                   │                    │           Owner
     │ Submit Review    │                   │                    │             │
     ├─────────────────▶│                   │                    │             │
     │                  │ Validate          │                    │             │
     │                  ├──────────┐        │                    │             │
     │                  │          │        │                    │             │
     │                  │◄─────────┘        │                    │             │
     │                  │                   │                    │             │
     │                  │ Save Review       │                    │             │
     │                  ├──────────────────▶│                    │             │
     │                  │                   │ Update Aggregate   │             │
     │                  │                   │ Scores            │             │
     │                  │                   ├────────┐          │             │
     │                  │                   │        │          │             │
     │                  │                   │◄───────┘          │             │
     │                  │                   │                    │             │
     │                  │                   │ Trigger Notify     │             │
     │                  │                   ├───────────────────▶│             │
     │                  │                   │                    │ Email       │
     │                  │                   │                    ├────────────▶│
     │                  │          Success  │                    │             │
     │ Review Saved     │◄──────────────────┤                    │             │
     │◄─────────────────┤                   │                    │             │
     │                  │                   │                    │             │

================================================================================
SECURITY ARCHITECTURE
================================================================================

┌─────────────────────────────────────────────────────────────────────────────┐
│                         SECURITY LAYERS                                      │
└─────────────────────────────────────────────────────────────────────────────┘

    Layer 1: Network Security              Layer 2: Application Security

    ┌──────────────────┐                  ┌──────────────────┐
    │   CloudFlare     │                  │  Authentication  │
    │   WAF + DDoS     │                  │                  │
    │                  │                  │ - JWT Tokens     │
    │ - Rate Limiting  │                  │ - OAuth 2.0      │
    │ - Bot Protection │                  │ - Session Mgmt   │
    │ - SSL/TLS 1.3    │                  └──────────────────┘
    └──────────────────┘
                                          ┌──────────────────┐
    Layer 3: Data Security                │  Authorization   │
                                          │                  │
    ┌──────────────────┐                  │ - Role-Based     │
    │  File Scanning   │                  │ - Permissions    │
    │                  │                  │ - Access Control │
    │ - ClamAV         │                  └──────────────────┘
    │ - AWS GuardDuty  │
    │ - Quarantine     │                  Layer 4: Storage Security
    └──────────────────┘
                                          ┌──────────────────┐
    ┌──────────────────┐                  │   Encryption     │
    │  Audit Logging   │                  │                  │
    │                  │                  │ - At Rest (AES)  │
    │ - All Operations │                  │ - In Transit TLS │
    │ - IP Tracking    │                  │ - Signed URLs    │
    │ - User Agent     │                  │ - Private Buckets│
    │ - Changes        │                  └──────────────────┘
    └──────────────────┘

================================================================================
SCALABILITY ARCHITECTURE
================================================================================

┌─────────────────────────────────────────────────────────────────────────────┐
│                    HORIZONTAL SCALING STRATEGY                               │
└─────────────────────────────────────────────────────────────────────────────┘

    Load Balancing:

                            ┌──────────────────┐
                            │   AWS ALB / ELB  │
                            │  Health Checks   │
                            └────────┬─────────┘
                                     │
                ┌────────────────────┼────────────────────┐
                │                    │                    │
         ┌──────▼──────┐      ┌──────▼──────┐    ┌──────▼──────┐
         │   Node 1    │      │   Node 2    │    │   Node N    │
         │  (Active)   │      │  (Active)   │    │  (Active)   │
         └─────────────┘      └─────────────┘    └─────────────┘
                │                    │                    │
                └────────────────────┼────────────────────┘
                                     │
                          ┌──────────▼──────────┐
                          │  Shared Resources:  │
                          │                     │
                          │ - PostgreSQL        │
                          │ - Redis Cache       │
                          │ - S3 Storage        │
                          │ - Message Queue     │
                          └─────────────────────┘

    Database Scaling:

        Primary                     Replicas                  Partitions

    ┌─────────────┐          ┌─────────────┐          ┌──────────────┐
    │  Master DB  │─────────▶│  Replica 1  │          │ 2025 Data    │
    │             │          │  (Reads)    │          ├──────────────┤
    │ Write/Read  │─────────▶│  Replica 2  │          │ 2024 Data    │
    │             │          │  (Analytics)│          ├──────────────┤
    └─────────────┘          └─────────────┘          │ Older Data   │
                                                       └──────────────┘

    Storage Scaling:

        Multi-Region S3                CDN Edge Locations

    ┌─────────────┐ Replicate  ┌─────────────┐
    │  US-East-1  │───────────▶│  US-West-2  │
    │  (Primary)  │            │  (Backup)   │
    └──────┬──────┘            └─────────────┘
           │
    ┌──────▼──────┐            ┌─────────────┐
    │ CloudFront  │───────────▶│ Edge: Tokyo │
    │  (CDN)      │            │ Edge: London│
    └─────────────┘            │ Edge: Sydney│
                               └─────────────┘

================================================================================
PERFORMANCE OPTIMIZATION
================================================================================

┌─────────────────────────────────────────────────────────────────────────────┐
│                        CACHING STRATEGY                                      │
└─────────────────────────────────────────────────────────────────────────────┘

    Layer 1: CDN Cache (CloudFront)
    ├─ Static Files: 1 year
    ├─ Public Evidence: 1 day
    └─ Thumbnails: 1 week

    Layer 2: Application Cache (Redis)
    ├─ Search Results: 5 minutes
    ├─ Evidence Metadata: 1 hour
    ├─ Review Aggregates: 15 minutes
    └─ User Sessions: 24 hours

    Layer 3: Database Cache (PostgreSQL)
    ├─ Materialized Views: Refresh hourly
    ├─ Query Plans: Automatic
    └─ Shared Buffers: 25% of RAM

    Layer 4: Client Cache (Browser)
    ├─ Static Assets: 1 year
    ├─ API Responses: 5 minutes
    └─ GraphQL Queries: Per-query

┌─────────────────────────────────────────────────────────────────────────────┐
│                        INDEX STRATEGY                                        │
└─────────────────────────────────────────────────────────────────────────────┘

    B-Tree Indexes (Fast Lookups):
    ├─ Primary Keys: All tables
    ├─ Foreign Keys: All references
    ├─ Unique Constraints: email, username, file_hash
    └─ Range Queries: created_at, file_size

    GIN Indexes (Array/JSON):
    ├─ search_vector: Full-text search
    ├─ keywords: Array contains
    ├─ authors: Array contains
    └─ topics: Array contains

    Partial Indexes (Selective):
    ├─ WHERE deleted_at IS NULL
    ├─ WHERE status = 'active'
    └─ WHERE processing_status != 'completed'

    Composite Indexes (Multiple Columns):
    ├─ (evidence_id, target_node_id)
    ├─ (file_hash, file_size)
    └─ (actor_id, created_at)

================================================================================
MONITORING & OBSERVABILITY
================================================================================

┌─────────────────────────────────────────────────────────────────────────────┐
│                        MONITORING STACK                                      │
└─────────────────────────────────────────────────────────────────────────────┘

    Metrics (Prometheus)                Logs (CloudWatch)

    ┌──────────────────┐               ┌──────────────────┐
    │ API Metrics      │               │ Application Logs │
    │                  │               │                  │
    │ - Request Rate   │               │ - Error Logs     │
    │ - Response Time  │               │ - Access Logs    │
    │ - Error Rate     │               │ - Audit Logs     │
    │ - Throughput     │               │ - Debug Logs     │
    └──────────────────┘               └──────────────────┘

    ┌──────────────────┐               ┌──────────────────┐
    │ Database Metrics │               │ Storage Metrics  │
    │                  │               │                  │
    │ - Query Time     │               │ - Upload Speed   │
    │ - Connection Pool│               │ - Storage Used   │
    │ - Cache Hit Rate │               │ - Bandwidth      │
    │ - Index Usage    │               │ - Costs          │
    └──────────────────┘               └──────────────────┘

    Alerting (PagerDuty)                Tracing (Jaeger)

    ┌──────────────────┐               ┌──────────────────┐
    │ Critical Alerts  │               │ Distributed      │
    │                  │               │ Tracing          │
    │ - System Down    │               │                  │
    │ - High Errors    │               │ - Request Flow   │
    │ - Cost Overrun   │               │ - Bottlenecks    │
    │ - Security Breach│               │ - Dependencies   │
    └──────────────────┘               └──────────────────┘

================================================================================
DISASTER RECOVERY
================================================================================

┌─────────────────────────────────────────────────────────────────────────────┐
│                        BACKUP STRATEGY                                       │
└─────────────────────────────────────────────────────────────────────────────┘

    Database Backups:
    ├─ Continuous: WAL Archiving (Point-in-time recovery)
    ├─ Daily: Full dump to S3 (retained 30 days)
    ├─ Weekly: Full dump to Glacier (retained 1 year)
    └─ Testing: Monthly restore test

    File Storage Backups:
    ├─ S3 Versioning: All file versions retained
    ├─ Cross-Region Replication: US-East → US-West
    ├─ Glacier Archive: Files > 180 days old
    └─ Testing: Quarterly restore test

    Recovery Objectives:
    ├─ RTO (Recovery Time): < 4 hours
    ├─ RPO (Recovery Point): < 1 hour
    └─ Data Loss: < 15 minutes (WAL streaming)

================================================================================
DEPLOYMENT PIPELINE
================================================================================

┌─────────────────────────────────────────────────────────────────────────────┐
│                        CI/CD PIPELINE                                        │
└─────────────────────────────────────────────────────────────────────────────┘

    Development                Testing                 Production

    ┌─────────────┐          ┌─────────────┐         ┌─────────────┐
    │ Git Commit  │          │  Run Tests  │         │   Deploy    │
    └──────┬──────┘          └──────┬──────┘         └──────┬──────┘
           │                        │                        │
           │ Push                   │ Success                │ Rolling
           ▼                        ▼                        ▼
    ┌─────────────┐          ┌─────────────┐         ┌─────────────┐
    │   GitHub    │─────────▶│  GitHub     │─────────▶│  Kubernetes │
    │             │          │  Actions    │         │    Cluster  │
    └─────────────┘          └─────────────┘         └─────────────┘
           │                        │                        │
           │                        │ DB Migration           │
           │                        ▼                        │
           │                 ┌─────────────┐                │
           │                 │  Flyway /   │                │
           │                 │  Liquibase  │                │
           │                 └─────────────┘                │
           │                                                 │
           │ Smoke Tests                                     │
           └─────────────────────────────────────────────────┘

================================================================================
COST OPTIMIZATION
================================================================================

┌─────────────────────────────────────────────────────────────────────────────┐
│                        COST BREAKDOWN                                        │
└─────────────────────────────────────────────────────────────────────────────┘

    Storage Costs (1TB):                API Costs:

    ┌──────────────────┐               ┌──────────────────┐
    │ S3 Standard      │               │ EC2 / ECS        │
    │ $23/month        │               │ $50-100/month    │
    └──────────────────┘               └──────────────────┘

    ┌──────────────────┐               ┌──────────────────┐
    │ S3 IA (archive)  │               │ Load Balancer    │
    │ $3/month         │               │ $15/month        │
    └──────────────────┐               └──────────────────┘

    Database Costs:                     CDN Costs:

    ┌──────────────────┐               ┌──────────────────┐
    │ RDS PostgreSQL   │               │ CloudFront       │
    │ $20-30/month     │               │ $5-10/month      │
    └──────────────────┘               └──────────────────┘

    Total: $70-120/month for medium scale (1TB, 10k daily uploads)

================================================================================
END OF ARCHITECTURE DIAGRAM
================================================================================
