╔══════════════════════════════════════════════════════════════════════════════════════════════╗
║                   CURATOR ROLES & PERMISSIONS SYSTEM ARCHITECTURE                            ║
║                              Project Rabbit Hole - Phase 3                                   ║
╚══════════════════════════════════════════════════════════════════════════════════════════════╝

┌──────────────────────────────────────────────────────────────────────────────────────────────┐
│                                    FRONTEND LAYER                                            │
└──────────────────────────────────────────────────────────────────────────────────────────────┘

    ┌─────────────────┐      ┌─────────────────┐      ┌─────────────────┐
    │  User Dashboard │      │  Curator Admin  │      │ Application UI  │
    │                 │      │   Dashboard     │      │                 │
    │  • My Profile   │      │  • Metrics      │      │  • Apply Form   │
    │  • My Actions   │      │  • Audit Logs   │      │  • Vote         │
    │  • Apply        │      │  • Reviews      │      │  • Status       │
    └────────┬────────┘      └────────┬────────┘      └────────┬────────┘
             │                        │                        │
             └────────────────────────┼────────────────────────┘
                                      │
                                      │ GraphQL Queries/Mutations
                                      ▼

┌──────────────────────────────────────────────────────────────────────────────────────────────┐
│                                   GRAPHQL API LAYER                                          │
└──────────────────────────────────────────────────────────────────────────────────────────────┘

    ┌───────────────────────────────────────────────────────────────────────────────┐
    │                          Apollo Server / Type-GraphQL                         │
    └───────────────────────────────────────────────────────────────────────────────┘

    ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  ┌──────────────┐
    │  CuratorRole    │  │  UserCurator    │  │  Application    │  │  AuditLog    │
    │   Resolver      │  │   Resolver      │  │   Resolver      │  │  Resolver    │
    │                 │  │                 │  │                 │  │              │
    │ • Query roles   │  │ • Query curators│  │ • Submit app    │  │ • Query logs │
    │ • Permissions   │  │ • Assign role   │  │ • Vote          │  │ • Log action │
    │                 │  │ • Update status │  │ • Review        │  │ • Review     │
    └────────┬────────┘  └────────┬────────┘  └────────┬────────┘  └──────┬───────┘
             │                    │                    │                   │
             └────────────────────┴────────────────────┴───────────────────┘
                                      │
                          ┌───────────┴───────────┐
                          │                       │
                          ▼                       ▼

    ┌──────────────────────────────┐   ┌──────────────────────────────┐
    │   Permission Middleware      │   │    Auth Middleware           │
    ├──────────────────────────────┤   ├──────────────────────────────┤
    │                              │   │                              │
    │ • RequireCuratorPermission   │   │ • Verify JWT Token           │
    │ • RequireActiveCurator       │   │ • Extract User ID            │
    │ • RequireCuratorRole         │   │ • Session Management         │
    │ • RequireCuratorTier         │   │                              │
    │ • EnforceRateLimit           │   │                              │
    │ • LogCuratorAction           │   │                              │
    │                              │   │                              │
    └──────────┬───────────────────┘   └──────────┬───────────────────┘
               │                                   │
               └───────────────┬───────────────────┘
                               │
                               ▼

┌──────────────────────────────────────────────────────────────────────────────────────────────┐
│                                  DATABASE LAYER                                              │
└──────────────────────────────────────────────────────────────────────────────────────────────┘

    ┌──────────────────────────────────────────────────────────────────────────────────────────┐
    │                                  PostgreSQL Database                                     │
    └──────────────────────────────────────────────────────────────────────────────────────────┘


    ╔════════════════════════════════════════════════════════════════════════════════╗
    ║                            CORE TABLES                                         ║
    ╚════════════════════════════════════════════════════════════════════════════════╝

    ┌─────────────────────┐         ┌─────────────────────┐         ┌─────────────────────┐
    │   CuratorRoles      │         │   UserCurators      │         │  CuratorApplications│
    ├─────────────────────┤         ├─────────────────────┤         ├─────────────────────┤
    │ PK  id              │◄────────│ FK  role_id         │         │ FK  role_id         │
    │     role_name       │         │ FK  user_id         │         │ FK  user_id         │
    │     display_name    │         │     status          │         │     status          │
    │     description     │         │     assigned_at     │         │     statement       │
    │     tier            │         │     expertise       │         │     votes_for       │
    │     min_reputation  │         │     total_actions   │         │     votes_against   │
    │     requires_app    │         │     accuracy_rate   │         │     voting_deadline │
    │     requires_vote   │         │     peer_review     │         │     decision        │
    └──────────┬──────────┘         └──────────┬──────────┘         └──────────┬──────────┘
               │                               │                               │
               │                               │                               │
               ▼                               ▼                               ▼
    ┌─────────────────────┐         ┌─────────────────────┐         ┌─────────────────────┐
    │  RolePermissions    │         │ CuratorPermissions  │         │ ApplicationVotes    │
    ├─────────────────────┤         ├─────────────────────┤         ├─────────────────────┤
    │ FK  role_id         │         │ FK  user_curator_id │         │ FK  application_id  │
    │     permission_type │         │     permission_type │         │ FK  voter_id        │
    │     resource_type   │         │     override_type   │         │     vote            │
    │     can_create      │         │     can_create      │         │     vote_weight     │
    │     can_edit        │         │     can_edit        │         │     rationale       │
    │     can_approve     │         │     expires_at      │         │     voted_at        │
    │     requires_review │         │     reason          │         └─────────────────────┘
    └─────────────────────┘         └─────────────────────┘


    ╔════════════════════════════════════════════════════════════════════════════════╗
    ║                        ACCOUNTABILITY TABLES                                   ║
    ╚════════════════════════════════════════════════════════════════════════════════╝

    ┌──────────────────────────────────────┐         ┌──────────────────────────────┐
    │      CuratorAuditLog                 │         │     CuratorReviews           │
    ├──────────────────────────────────────┤         ├──────────────────────────────┤
    │ PK  id                               │◄────────│ FK  audit_log_id             │
    │ FK  curator_id                       │         │ FK  reviewer_id              │
    │ FK  user_id                          │         │     review_type              │
    │     action_type                      │         │     rating (1-5)             │
    │     resource_type                    │         │     verdict                  │
    │     resource_id                      │         │     comments                 │
    │     old_value (JSONB)                │         │     specific_concerns[]      │
    │     new_value (JSONB)                │         │     recommendations[]        │
    │     changes (JSONB)                  │         │     action_required          │
    │     reason                           │         │     escalated                │
    │     requires_peer_review             │         │     reviewed_at              │
    │     peer_reviewed                    │         └──────────────────────────────┘
    │     peer_review_status               │
    │     ip_address                       │
    │     user_agent                       │
    │     performed_at                     │
    └──────────────────────────────────────┘


    ╔════════════════════════════════════════════════════════════════════════════════╗
    ║                           HELPER FUNCTIONS                                     ║
    ╚════════════════════════════════════════════════════════════════════════════════╝

    ┌──────────────────────────────────────────────────────────────────────────────┐
    │  check_curator_permission(user_id, permission_type, resource_type, action)   │
    │  ─────────────────────────────────────────────────────────────────────────   │
    │  Returns: BOOLEAN                                                            │
    │  Logic:                                                                      │
    │    1. Get active curator record for user                                     │
    │    2. Check user-specific permission overrides (grants)                      │
    │    3. Check user-specific permission revocations                             │
    │    4. Check role-based permissions                                           │
    │    5. Return permission status                                               │
    └──────────────────────────────────────────────────────────────────────────────┘

    ┌──────────────────────────────────────────────────────────────────────────────┐
    │  log_curator_action(curator_id, user_id, action_type, resource_type,        │
    │                     resource_id, old_value, new_value, reason, ip, agent)   │
    │  ─────────────────────────────────────────────────────────────────────────   │
    │  Returns: UUID (audit_log_id)                                               │
    │  Logic:                                                                      │
    │    1. Determine if action requires peer review                               │
    │    2. Insert audit log entry                                                 │
    │    3. Update curator total_actions count                                     │
    │    4. Return audit log ID                                                    │
    └──────────────────────────────────────────────────────────────────────────────┘

    ┌──────────────────────────────────────────────────────────────────────────────┐
    │  update_curator_metrics(curator_id)                                          │
    │  ─────────────────────────────────────────────────────────────────────────   │
    │  Returns: VOID                                                               │
    │  Logic:                                                                      │
    │    1. Count total actions from audit log                                     │
    │    2. Count approved actions from reviews                                    │
    │    3. Count overturned actions from reviews                                  │
    │    4. Calculate average peer review rating                                   │
    │    5. Calculate accuracy rate                                                │
    │    6. Update UserCurators metrics                                            │
    └──────────────────────────────────────────────────────────────────────────────┘


    ╔════════════════════════════════════════════════════════════════════════════════╗
    ║                            VIEWS                                               ║
    ╚════════════════════════════════════════════════════════════════════════════════╝

    ┌────────────────────────┐  ┌────────────────────────┐  ┌──────────────────────┐
    │  ActiveCuratorsView    │  │ PendingApplicationsView│  │  CuratorAuditLogView │
    ├────────────────────────┤  ├────────────────────────┤  ├──────────────────────┤
    │ Joins:                 │  │ Joins:                 │  │ Joins:               │
    │  • UserCurators        │  │  • Applications        │  │  • AuditLog          │
    │  • Users               │  │  • Users               │  │  • UserCurators      │
    │  • CuratorRoles        │  │  • CuratorRoles        │  │  • Users             │
    │                        │  │                        │  │  • CuratorRoles      │
    │ Filters:               │  │ Filters:               │  │  • CuratorReviews    │
    │  • status = 'active'   │  │  • status IN (...)     │  │                      │
    │                        │  │  • voting_deadline >   │  │ Aggregates:          │
    │ Returns:               │  │                        │  │  • review_count      │
    │  • Curator details     │  │ Computes:              │  │                      │
    │  • Role info           │  │  • approval_ratio      │  │ Returns:             │
    │  • Performance metrics │  │                        │  │  • Full audit trail  │
    └────────────────────────┘  └────────────────────────┘  └──────────────────────┘


┌──────────────────────────────────────────────────────────────────────────────────────────────┐
│                                DATA FLOW DIAGRAMS                                            │
└──────────────────────────────────────────────────────────────────────────────────────────────┘

╔════════════════════════════════════════════════════════════════════════════════╗
║                       FLOW 1: APPLY FOR CURATOR ROLE                           ║
╚════════════════════════════════════════════════════════════════════════════════╝

    User                Frontend            GraphQL API          Middleware         Database
     │                     │                     │                    │                │
     │  Click "Apply"      │                     │                    │                │
     ├────────────────────>│                     │                    │                │
     │                     │                     │                    │                │
     │                     │  submitCuratorApplication                │                │
     │                     ├────────────────────>│                    │                │
     │                     │                     │   @Authorized      │                │
     │                     │                     ├───────────────────>│                │
     │                     │                     │   ✓ Authenticated  │                │
     │                     │                     │<───────────────────┤                │
     │                     │                     │                    │                │
     │                     │                     │  Check reputation & contributions   │
     │                     │                     ├────────────────────────────────────>│
     │                     │                     │  UserReputation query               │
     │                     │                     │<────────────────────────────────────┤
     │                     │                     │  reputation: 1250, contributions: 67│
     │                     │                     │                    │                │
     │                     │                     │  Check requirements                 │
     │                     │                     ├────────────────────────────────────>│
     │                     │                     │  CuratorRoles query                 │
     │                     │                     │<────────────────────────────────────┤
     │                     │                     │  min_reputation: 1000 ✓             │
     │                     │                     │                    │                │
     │                     │                     │  Insert application                 │
     │                     │                     ├────────────────────────────────────>│
     │                     │                     │  status: 'submitted'                │
     │                     │                     │<────────────────────────────────────┤
     │                     │                     │  application created                │
     │                     │                     │                    │                │
     │                     │  Application        │                    │                │
     │                     │<────────────────────┤                    │                │
     │  Success message    │                     │                    │                │
     │<────────────────────┤                     │                    │                │
     │  "App submitted,    │                     │                    │                │
     │   voting opens in   │                     │                    │                │
     │   24 hours"         │                     │                    │                │


╔════════════════════════════════════════════════════════════════════════════════╗
║                     FLOW 2: COMMUNITY VOTING                                   ║
╚════════════════════════════════════════════════════════════════════════════════╝

    Voter               Frontend            GraphQL API          Middleware         Database
     │                     │                     │                    │                │
     │  View applications  │                     │                    │                │
     ├────────────────────>│                     │                    │                │
     │                     │  curatorApplications                     │                │
     │                     ├────────────────────>│                    │                │
     │                     │                     │  Query applications                │
     │                     │                     ├────────────────────────────────────>│
     │                     │                     │  status = 'voting'                  │
     │                     │                     │<────────────────────────────────────┤
     │                     │  Applications list  │                    │                │
     │                     │<────────────────────┤                    │                │
     │  Display apps       │                     │                    │                │
     │<────────────────────┤                     │                    │                │
     │                     │                     │                    │                │
     │  Click "Vote For"   │                     │                    │                │
     ├────────────────────>│                     │                    │                │
     │                     │  voteOnCuratorApplication                │                │
     │                     ├────────────────────>│                    │                │
     │                     │                     │   @Authorized      │                │
     │                     │                     ├───────────────────>│                │
     │                     │                     │<───────────────────┤                │
     │                     │                     │                    │                │
     │                     │                     │  Get voter reputation               │
     │                     │                     ├────────────────────────────────────>│
     │                     │                     │  UserReputation query               │
     │                     │                     │<────────────────────────────────────┤
     │                     │                     │  reputation: 800                    │
     │                     │                     │                    │                │
     │                     │                     │  Calculate vote weight              │
     │                     │                     │  weight = min(5, max(1, 800/200))   │
     │                     │                     │  weight = 4.0                       │
     │                     │                     │                    │                │
     │                     │                     │  Insert/Update vote                 │
     │                     │                     ├────────────────────────────────────>│
     │                     │                     │  vote: 'for', weight: 4.0           │
     │                     │                     │  ▼ TRIGGER                          │
     │                     │                     │  Update application vote counts     │
     │                     │                     │<────────────────────────────────────┤
     │                     │  Vote recorded      │                    │                │
     │                     │<────────────────────┤                    │                │
     │  "Vote recorded"    │                     │                    │                │
     │<────────────────────┤                     │                    │                │


╔════════════════════════════════════════════════════════════════════════════════╗
║                  FLOW 3: CURATOR ACTION WITH PERMISSION CHECK                  ║
╚════════════════════════════════════════════════════════════════════════════════╝

    Curator             Frontend            GraphQL API          Middleware         Database
     │                     │                     │                    │                │
     │ "Promote to Level 0"│                     │                    │                │
     ├────────────────────>│                     │                    │                │
     │                     │  promoteNodeToLevel0                     │                │
     │                     ├────────────────────>│                    │                │
     │                     │                     │  @UseMiddleware    │                │
     │                     │                     │  RequireCuratorPermission           │
     │                     │                     ├───────────────────>│                │
     │                     │                     │                    │ check_curator_permission()
     │                     │                     │                    ├───────────────>│
     │                     │                     │                    │  1. Get curator│
     │                     │                     │                    │  2. Check overrides
     │                     │                     │                    │  3. Check role perms
     │                     │                     │                    │<───────────────┤
     │                     │                     │                    │  ✓ Has permission
     │                     │                     │  ✓ Permission OK   │                │
     │                     │                     │<───────────────────┤                │
     │                     │                     │                    │                │
     │                     │                     │  Update node weight                 │
     │                     │                     ├────────────────────────────────────>│
     │                     │                     │  weight: 1.0                        │
     │                     │                     │<────────────────────────────────────┤
     │                     │                     │                    │                │
     │                     │                     │  LogCuratorAction  │                │
     │                     │                     ├───────────────────>│                │
     │                     │                     │                    │ log_curator_action()
     │                     │                     │                    ├───────────────>│
     │                     │                     │                    │  Insert audit log
     │                     │                     │                    │  Update metrics
     │                     │                     │                    │<───────────────┤
     │                     │                     │  ✓ Logged          │                │
     │                     │                     │<───────────────────┤                │
     │                     │                     │                    │                │
     │                     │  Node promoted      │                    │                │
     │                     │<────────────────────┤                    │                │
     │  "Level 0 promotion"│                     │                    │                │
     │  "successful"       │                     │                    │                │
     │<────────────────────┤                     │                    │                │


╔════════════════════════════════════════════════════════════════════════════════╗
║                         FLOW 4: PEER REVIEW                                    ║
╚════════════════════════════════════════════════════════════════════════════════╝

   Reviewer             Frontend            GraphQL API          Middleware         Database
     │                     │                     │                    │                │
     │ View pending reviews│                     │                    │                │
     ├────────────────────>│                     │                    │                │
     │                     │  curatorAuditLogs(requiresPeerReview: true)              │
     │                     ├────────────────────>│                    │                │
     │                     │                     │  Query audit logs                  │
     │                     │                     ├────────────────────────────────────>│
     │                     │                     │<────────────────────────────────────┤
     │                     │  Pending actions    │                    │                │
     │                     │<────────────────────┤                    │                │
     │  Display list       │                     │                    │                │
     │<────────────────────┤                     │                    │                │
     │                     │                     │                    │                │
     │ Submit review       │                     │                    │                │
     ├────────────────────>│                     │                    │                │
     │                     │  submitCuratorReview                     │                │
     │                     ├────────────────────>│                    │                │
     │                     │                     │  @Authorized       │                │
     │                     │                     │  RequireActiveCurator               │
     │                     │                     ├───────────────────>│                │
     │                     │                     │<───────────────────┤                │
     │                     │                     │                    │                │
     │                     │                     │  Check permission  │                │
     │                     │                     ├────────────────────────────────────>│
     │                     │                     │  curator_review permission          │
     │                     │                     │<────────────────────────────────────┤
     │                     │                     │  ✓ Can review      │                │
     │                     │                     │                    │                │
     │                     │                     │  Insert review                      │
     │                     │                     ├────────────────────────────────────>│
     │                     │                     │  verdict: 'approved'                │
     │                     │                     │<────────────────────────────────────┤
     │                     │                     │                    │                │
     │                     │                     │  Update audit log                   │
     │                     │                     ├────────────────────────────────────>│
     │                     │                     │  peer_reviewed: true                │
     │                     │                     │<────────────────────────────────────┤
     │                     │                     │                    │                │
     │                     │                     │  update_curator_metrics()           │
     │                     │                     ├────────────────────────────────────>│
     │                     │                     │<────────────────────────────────────┤
     │                     │                     │                    │                │
     │                     │  Review submitted   │                    │                │
     │                     │<────────────────────┤                    │                │
     │  "Review recorded"  │                     │                    │                │
     │<────────────────────┤                     │                    │                │


┌──────────────────────────────────────────────────────────────────────────────────────────────┐
│                              SECURITY ARCHITECTURE                                           │
└──────────────────────────────────────────────────────────────────────────────────────────────┘

    ╔═══════════════════════════════════════════════════════════════════════╗
    ║                      MULTI-LAYER SECURITY                             ║
    ╚═══════════════════════════════════════════════════════════════════════╝

    ┌───────────────────────────────────────────────────────────────────────┐
    │ Layer 1: Authentication                                               │
    ├───────────────────────────────────────────────────────────────────────┤
    │  • JWT token verification                                             │
    │  • Session management                                                 │
    │  • User ID extraction                                                 │
    └───────────────────────────────────────────────────────────────────────┘
                                    ▼
    ┌───────────────────────────────────────────────────────────────────────┐
    │ Layer 2: Curator Status Verification                                  │
    ├───────────────────────────────────────────────────────────────────────┤
    │  • Check curator exists                                               │
    │  • Verify status = 'active'                                           │
    │  • Check not suspended/revoked                                        │
    └───────────────────────────────────────────────────────────────────────┘
                                    ▼
    ┌───────────────────────────────────────────────────────────────────────┐
    │ Layer 3: Permission Verification                                      │
    ├───────────────────────────────────────────────────────────────────────┤
    │  • Check role-based permissions                                       │
    │  • Check individual overrides (grants)                                │
    │  • Check individual revocations                                       │
    │  • Verify resource type matches                                       │
    └───────────────────────────────────────────────────────────────────────┘
                                    ▼
    ┌───────────────────────────────────────────────────────────────────────┐
    │ Layer 4: Rate Limiting                                                │
    ├───────────────────────────────────────────────────────────────────────┤
    │  • Check daily action count                                           │
    │  • Compare against role limits                                        │
    │  • Reject if limit exceeded                                           │
    └───────────────────────────────────────────────────────────────────────┘
                                    ▼
    ┌───────────────────────────────────────────────────────────────────────┐
    │ Layer 5: Action Logging                                               │
    ├───────────────────────────────────────────────────────────────────────┤
    │  • Log all curator actions                                            │
    │  • Capture IP address & user agent                                    │
    │  • Store before/after values                                          │
    │  • Flag for peer review if required                                   │
    └───────────────────────────────────────────────────────────────────────┘
                                    ▼
    ┌───────────────────────────────────────────────────────────────────────┐
    │ Layer 6: Peer Review (for critical actions)                           │
    ├───────────────────────────────────────────────────────────────────────┤
    │  • Other curators review action                                       │
    │  • Rate action quality                                                │
    │  • Flag issues or approve                                             │
    │  • Update curator metrics                                             │
    └───────────────────────────────────────────────────────────────────────┘


╔══════════════════════════════════════════════════════════════════════════════════════════════╗
║                                    KEY METRICS                                               ║
╚══════════════════════════════════════════════════════════════════════════════════════════════╝

    Database Metrics                        Performance Metrics
    ────────────────                        ───────────────────
    • 8 Tables                              • Permission check: < 10ms
    • 3 Functions                           • Audit log insert: < 20ms
    • 3 Views                               • Metrics update: < 50ms
    • 15+ Permissions seeded                • Application query: < 100ms
    • 5 Curator roles                       • Complex audit query: < 200ms

    Security Features                       Accountability Features
    ─────────────────                       ───────────────────────
    • Role-based access control             • Complete audit trail
    • Individual permission overrides       • Peer review system
    • Rate limiting                         • Performance metrics
    • Action logging                        • Suspension/warning system
    • IP/session tracking                   • Public promotion ledger

╔══════════════════════════════════════════════════════════════════════════════════════════════╗
║                                  INTEGRATION POINTS                                          ║
╚══════════════════════════════════════════════════════════════════════════════════════════════╝

    External Systems                        Internal Systems
    ────────────────                        ────────────────
    • UserReputation (from Phase 2)         • Level 0 Content Management
    • Challenge System (from Phase 2)       • Node/Edge Promotion
    • Evidence Management (Phase 2.5)       • Veracity Score System
    • User Authentication                   • Community Consensus
                                           • Methodology Validation

╔══════════════════════════════════════════════════════════════════════════════════════════════╗
║                                 END OF ARCHITECTURE                                          ║
╚══════════════════════════════════════════════════════════════════════════════════════════════╝
