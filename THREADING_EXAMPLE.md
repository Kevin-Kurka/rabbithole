# Threaded Comments - Visual Example

## User Interaction Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         NODE: "Climate Evidence"                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ’¬ Comments                                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                       â”‚
â”‚ ğŸ‘¤ @alice â€¢ 5m ago                                                   â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ This evidence supports the hypothesis. @bob should review     â”‚   â”‚
â”‚ â”‚ the methodology section.                                       â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚ [Reply] 2 replies                                                    â”‚
â”‚                                                                       â”‚
â”‚     ğŸ‘¤ @bob â€¢ 3m ago                                                 â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚     â”‚ @alice I agree, but we need more sources to validate   â”‚     â”‚
â”‚     â”‚ this claim. The sample size seems small.                â”‚     â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚     [Reply] 1 reply                                                  â”‚
â”‚                                                                       â”‚
â”‚         ğŸ‘¤ @charlie â€¢ 1m ago                                         â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚         â”‚ I found additional sources @alice @bob! Check     â”‚       â”‚
â”‚         â”‚ the new evidence node I just added.               â”‚       â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚         [Reply]                                                      â”‚
â”‚                                                                       â”‚
â”‚     ğŸ‘¤ @alice â€¢ 2m ago                                               â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚     â”‚ @bob Good point. I'll add more peer-reviewed papers.   â”‚     â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚     [Reply]                                                          â”‚
â”‚                                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Notification Flow

### Bob's Notification Feed (when Alice mentions him)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ”” Notifications                                [Mark all as read]   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                       â”‚
â”‚ ğŸ”µ You were mentioned                                     â€¢ 1m ago   â”‚
â”‚    @charlie mentioned you in a comment                               â”‚
â”‚    "I found additional sources @alice @bob! Check..."                â”‚
â”‚                                                                       â”‚
â”‚ ğŸ”µ New reply to your comment                              â€¢ 2m ago   â”‚
â”‚    @alice replied to your comment                                    â”‚
â”‚    "@bob Good point. I'll add more peer-reviewed..."                 â”‚
â”‚                                                                       â”‚
â”‚    You were mentioned                                     â€¢ 5m ago   â”‚
â”‚    @alice mentioned you in a comment                                 â”‚
â”‚    "This evidence supports the hypothesis. @bob should..."           â”‚
â”‚                                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Database Representation

```sql
-- Top-level comment by Alice
INSERT INTO "Comments" (id, text, author_id, target_node_id, parent_comment_id)
VALUES (
  'comment-1',
  'This evidence supports the hypothesis. @bob should review...',
  'alice-uuid',
  'node-uuid',
  NULL  -- No parent (top-level)
);

-- Bob's reply to Alice
INSERT INTO "Comments" (id, text, author_id, target_node_id, parent_comment_id)
VALUES (
  'comment-2',
  '@alice I agree, but we need more sources to validate...',
  'bob-uuid',
  'node-uuid',
  'comment-1'  -- Parent is Alice's comment
);

-- Charlie's reply to Bob
INSERT INTO "Comments" (id, text, author_id, target_node_id, parent_comment_id)
VALUES (
  'comment-3',
  'I found additional sources @alice @bob! Check...',
  'charlie-uuid',
  'node-uuid',
  'comment-2'  -- Parent is Bob's comment
);

-- Alice's second reply to Bob (sibling of Charlie's comment)
INSERT INTO "Comments" (id, text, author_id, target_node_id, parent_comment_id)
VALUES (
  'comment-4',
  '@bob Good point. I will add more peer-reviewed papers.',
  'alice-uuid',
  'node-uuid',
  'comment-2'  -- Parent is Bob's comment (same as Charlie's)
);
```

## Notification Records Created

```sql
-- Notification 1: Alice mentions Bob (from comment-1)
INSERT INTO "Notifications" (user_id, type, title, message, entity_id, related_user_id)
VALUES (
  'bob-uuid',
  'mention',
  'You were mentioned',
  '@alice mentioned you in a comment',
  'node-uuid',
  'alice-uuid'
);

-- Notification 2: Bob replies to Alice (from comment-2)
INSERT INTO "Notifications" (user_id, type, title, message, entity_id, related_user_id)
VALUES (
  'alice-uuid',
  'reply',
  'New reply to your comment',
  '@bob replied to your comment',
  'node-uuid',
  'bob-uuid'
);

-- Notification 3: Charlie mentions Alice (from comment-3)
INSERT INTO "Notifications" (user_id, type, title, message, entity_id, related_user_id)
VALUES (
  'alice-uuid',
  'mention',
  'You were mentioned',
  '@charlie mentioned you in a comment',
  'node-uuid',
  'charlie-uuid'
);

-- Notification 4: Charlie mentions Bob (from comment-3)
INSERT INTO "Notifications" (user_id, type, title, message, entity_id, related_user_id)
VALUES (
  'bob-uuid',
  'mention',
  'You were mentioned',
  '@charlie mentioned you in a comment',
  'node-uuid',
  'charlie-uuid'
);

-- Notification 5: Charlie replies to Bob (from comment-3)
INSERT INTO "Notifications" (user_id, type, title, message, entity_id, related_user_id)
VALUES (
  'bob-uuid',
  'reply',
  'New reply to your comment',
  '@charlie replied to your comment',
  'node-uuid',
  'charlie-uuid'
);

-- Notification 6: Alice replies to Bob (from comment-4)
-- NOTE: Alice mentioned Bob, but she's also replying to him
-- Only ONE notification is sent (reply takes precedence over mention in same thread)
INSERT INTO "Notifications" (user_id, type, title, message, entity_id, related_user_id)
VALUES (
  'bob-uuid',
  'reply',
  'New reply to your comment',
  '@alice replied to your comment',
  'node-uuid',
  'alice-uuid'
);
```

## GraphQL Query Result

```json
{
  "data": {
    "getComments": [
      {
        "id": "comment-1",
        "text": "This evidence supports the hypothesis. @bob should review...",
        "author": { "username": "alice" },
        "createdAt": "2025-10-10T10:00:00Z",
        "parentCommentId": null,
        "replies": [
          {
            "id": "comment-2",
            "text": "@alice I agree, but we need more sources to validate...",
            "author": { "username": "bob" },
            "createdAt": "2025-10-10T10:02:00Z",
            "parentCommentId": "comment-1",
            "replies": [
              {
                "id": "comment-3",
                "text": "I found additional sources @alice @bob! Check...",
                "author": { "username": "charlie" },
                "createdAt": "2025-10-10T10:04:00Z",
                "parentCommentId": "comment-2"
              },
              {
                "id": "comment-4",
                "text": "@bob Good point. I will add more peer-reviewed papers.",
                "author": { "username": "alice" },
                "createdAt": "2025-10-10T10:03:00Z",
                "parentCommentId": "comment-2"
              }
            ]
          }
        ]
      }
    ]
  }
}
```

## Real-time Event Flow

```
TIME: 10:00 AM
Alice types comment with @bob
    â†“
Backend: createComment mutation
    â†“
Backend: Parse "@bob" from text
    â†“
Backend: Lookup bob-uuid from username
    â†“
Backend: Create notification for Bob (type: mention)
    â†“
Backend: Publish to Redis â†’ NOTIFICATION_CREATED_bob-uuid
    â†“
Backend: Publish to Redis â†’ NEW_COMMENT
    â†“
WebSocket: Push notification to Bob's browser
    â†“
Bob's UI: Bell icon badge updates (1 â†’ 2)
    â†“
All users viewing node: Comment appears in thread

---

TIME: 10:02 AM
Bob clicks "Reply" on Alice's comment
Bob types: "@alice I agree..."
    â†“
Backend: createComment with parent_comment_id = comment-1
    â†“
Backend: Parse "@alice" from text
    â†“
Backend: Detect reply to Alice's comment
    â†“
Backend: Create notification for Alice (type: reply)
    â†“
Backend: Skip duplicate mention notification (same thread)
    â†“
WebSocket: Push to Alice's browser
    â†“
Alice's UI: Bell icon updates, dropdown shows new reply

---

TIME: 10:04 AM
Charlie replies to Bob with "@alice @bob"
    â†“
Backend: Parse two mentions
    â†“
Backend: Create 3 notifications:
  1. Reply notification to Bob (parent comment author)
  2. Mention notification to Alice
  3. Mention notification to Bob (but Bob already gets reply, so merge)
    â†“
WebSocket: Push to both Alice and Bob
    â†“
Both users: Real-time notification + comment appears
```

## Component Hierarchy

```
<ThreadedComments targetId="node-uuid">
  â”‚
  â”œâ”€ <CommentForm> (top-level)
  â”‚   â””â”€ <textarea> with @mention detection
  â”‚
  â””â”€ <CommentList>
      â”‚
      â”œâ”€ <CommentItem comment={comment-1}>
      â”‚   â”œâ”€ <Avatar username="alice" />
      â”‚   â”œâ”€ <CommentText highlighted mentions />
      â”‚   â”œâ”€ <ReplyButton onClick={showReplyForm} />
      â”‚   â”‚
      â”‚   â””â”€ <RepliesList>
      â”‚       â”‚
      â”‚       â”œâ”€ <CommentItem comment={comment-2}>
      â”‚       â”‚   â”œâ”€ <Avatar username="bob" />
      â”‚       â”‚   â”œâ”€ <CommentText />
      â”‚       â”‚   â”‚
      â”‚       â”‚   â””â”€ <RepliesList>
      â”‚       â”‚       â”œâ”€ <CommentItem comment={comment-3} />
      â”‚       â”‚       â””â”€ <CommentItem comment={comment-4} />
      â”‚       â”‚
      â”‚       â””â”€ [Conditional] <ReplyForm parentId={comment-2} />
      â”‚
      â””â”€ [More top-level comments...]
```

## State Management

### Frontend State (React):

```typescript
const [comments, setComments] = useState<Comment[]>([]);
const [replyingTo, setReplyingTo] = useState<string | null>(null);
const [replyText, setReplyText] = useState<{ [commentId: string]: string }>({});

// When user clicks "Reply" on comment-2
setReplyingTo('comment-2');
setReplyText({ 'comment-2': '@bob ' }); // Pre-fill mention

// When user submits reply
createComment({
  variables: {
    input: {
      targetId: 'node-uuid',
      text: replyText['comment-2'],
      parentCommentId: 'comment-2'
    }
  }
});

// Reset state after mutation
setReplyingTo(null);
setReplyText({});
```

### Apollo Cache Update:

```typescript
// Subscription handler
useSubscription(NEW_COMMENT_SUBSCRIPTION, {
  onData: ({ data }) => {
    const newComment = data.data?.newComment;

    // Refetch all comments to rebuild thread tree
    refetch();

    // Alternative: Optimistic update
    const existingComments = cache.readQuery({ query: GET_COMMENTS });
    cache.writeQuery({
      query: GET_COMMENTS,
      data: {
        getComments: [...existingComments.getComments, newComment]
      }
    });
  }
});
```

## Performance Considerations

### Indexes Created:
- `idx_comments_parent_id` - Fast thread traversal
- `idx_notifications_user_id` - Fast user notification lookup
- `idx_notifications_read` - Efficient unread filtering

### Query Optimization:
```sql
-- Fetch comments with single JOIN (avoid N+1)
SELECT c.*, u.id as author_id, u.username, u.email
FROM "Comments" c
JOIN "Users" u ON c.author_id = u.id
WHERE c.target_node_id = $1
ORDER BY c.created_at ASC;

-- Use field resolver for lazy-loading replies
-- Only fetches when client requests 'replies' field
```

### Subscription Efficiency:
- User-scoped channels prevent broadcast spam
- Only relevant users receive notifications
- No polling for notifications (pure WebSocket)
